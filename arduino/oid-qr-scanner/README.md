# BrainSAIT OID QR Code Scanner

An Arduino/ESP32-based QR code scanner that reads and processes BrainSAIT OID (Object Identifier) codes for asset tracking, device identification, and healthcare system integration.

## Overview

This scanner reads QR codes generated by the [BrainSAIT OID Registry Platform](https://github.com/Fadil369/brainsait-oid-integr) and:

- Parses OID data from QR codes
- Validates OIDs against the BrainSAIT namespace (PEN 61026)
- Sends scan data to the BrainSAIT API
- Stores scan history locally
- Provides visual/audio feedback

## Hardware Options

### Option 1: ESP32-CAM (Recommended)

The ESP32-CAM module has a built-in camera, making it a complete standalone solution.

**Components:**
| Component | Quantity | Notes |
|-----------|----------|-------|
| ESP32-CAM (AI-Thinker) | 1 | With OV2640 camera |
| FTDI USB-TTL Adapter | 1 | For programming (3.3V) |
| 5V 2A Power Supply | 1 | USB or barrel jack |
| Active Buzzer | 1 | 3.3V compatible |
| LED (optional) | 1 | Status indicator |
| Jumper Wires | Several | Female-to-female |

**Wiring Diagram:**
```
ESP32-CAM          FTDI Adapter
---------          ------------
  GND  ------------ GND
  5V   ------------ VCC (5V)
  U0R  ------------ TX
  U0T  ------------ RX
  IO0  ------------ GND (only during upload!)

ESP32-CAM          Buzzer
---------          ------
  IO12 ------------ + (Signal)
  GND  ------------ - (Ground)

ESP32-CAM          Status LED
---------          ----------
  IO33 ------------ Anode (+) via 220Ω resistor
  GND  ------------ Cathode (-)
```

**Programming Mode:**
1. Connect IO0 to GND
2. Press RST button
3. Upload code
4. Disconnect IO0 from GND
5. Press RST to run

### Option 2: ESP32 + GM65 QR Scanner Module

For more reliable scanning, use a dedicated QR scanner module.

**Components:**
| Component | Quantity | Notes |
|-----------|----------|-------|
| ESP32 DevKit | 1 | Any ESP32 board |
| GM65 QR Scanner | 1 | UART interface |
| OLED Display (optional) | 1 | SSD1306 128x64 |
| Active Buzzer | 1 | 3.3V compatible |
| 5V Power Supply | 1 | 2A recommended |

**Wiring Diagram:**
```
ESP32              GM65 Scanner
-----              ------------
  3.3V ----------- VCC
  GND  ----------- GND
  GPIO16 --------- TX (Scanner TX → ESP RX)
  GPIO17 --------- RX (Scanner RX → ESP TX)

ESP32              Buzzer
-----              ------
  GPIO4 ---------- + (Signal)
  GND  ----------- - (Ground)

ESP32              OLED Display (I2C)
-----              ------------------
  GPIO21 --------- SDA
  GPIO22 --------- SCL
  3.3V ----------- VCC
  GND  ----------- GND
```

## Software Setup

### 1. Install Arduino IDE

Download from [arduino.cc](https://www.arduino.cc/en/software) (version 2.x recommended)

### 2. Add ESP32 Board Support

1. Open Arduino IDE
2. Go to **File → Preferences**
3. Add to "Additional Board Manager URLs":
   ```
   https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json
   ```
4. Go to **Tools → Board → Boards Manager**
5. Search "ESP32" and install **esp32 by Espressif Systems**

### 3. Install Required Libraries

Go to **Sketch → Include Library → Manage Libraries** and install:

| Library | Version | Purpose |
|---------|---------|---------|
| ArduinoJson | 6.x | JSON parsing |
| WiFi | (built-in) | Network connectivity |
| HTTPClient | (built-in) | API requests |

**For ESP32-CAM:**
| Library | Version | Purpose |
|---------|---------|---------|
| esp32-camera | (built-in) | Camera driver |
| quirc | Latest | QR code decoding |

To install quirc:
1. Download from https://github.com/dlbeer/quirc
2. Add to Arduino libraries folder

**For OLED Display (optional):**
| Library | Version | Purpose |
|---------|---------|---------|
| Adafruit_SSD1306 | Latest | OLED driver |
| Adafruit_GFX | Latest | Graphics library |

### 4. Configure the Scanner

1. Copy `config.h` to `config_local.h`
2. Edit `config_local.h` with your settings:

```cpp
// WiFi credentials
#define WIFI_SSID     "YourWiFiNetwork"
#define WIFI_PASSWORD "YourWiFiPassword"

// BrainSAIT API (get from admin)
#define BRAINSAIT_API_URL "https://api.brainsait.com/oid"
#define BRAINSAIT_API_KEY "your-api-key"

// Device identification
#define DEVICE_OID      "1.3.6.1.4.1.61026.4.3.1"
#define DEVICE_NAME     "Scanner-001"
#define DEVICE_LOCATION "Riyadh-HQ"
```

### 5. Upload the Code

1. Select board: **Tools → Board → ESP32 Arduino → AI Thinker ESP32-CAM**
2. Select port: **Tools → Port → /dev/cu.usbserial-XXX** (macOS) or **COM3** (Windows)
3. Click **Upload**

## QR Code Format

The scanner expects QR codes with JSON data in this format:

```json
{
  "oid": "1.3.6.1.4.1.61026.3.2.1",
  "name": "AI Normalizer Service",
  "description": "Clinical coding and claim normalization",
  "nodeType": "leaf",
  "status": "active",
  "pen": 61026,
  "provider": "BrainSAIT Enterprise"
}
```

Generate QR codes using the [OID Registry Platform](https://github.com/Fadil369/brainsait-oid-integr).

## Usage

### Serial Commands

Connect via Serial Monitor (115200 baud):

| Command | Description |
|---------|-------------|
| `help` | Show available commands |
| `status` | Display device status |
| `history` | Show recent scan history |
| `clear` | Clear scan history |
| `reconnect` | Reconnect to WiFi |
| `test <oid>` | Test scan with specific OID |

### LED Indicators

| Pattern | Meaning |
|---------|---------|
| Solid ON | WiFi connected, ready |
| Blinking | Connecting to WiFi |
| Off | WiFi disconnected |
| 3x Fast blink | Scan successful |
| 2x Slow blink | Scan error |

### Buzzer Feedback

| Sound | Meaning |
|-------|---------|
| High-low beep | Successful scan |
| Low-low beep | Error/invalid QR |

## API Integration

The scanner sends POST requests to the BrainSAIT API:

**Endpoint:** `POST /oid/scan`

**Headers:**
```
Content-Type: application/json
X-BrainSAIT-API-Key: <your-key>
X-BrainSAIT-Device: OID-Scanner-ESP32
X-BrainSAIT-OID: <scanned-oid>
X-BrainSAIT-PEN: 61026
```

**Body:**
```json
{
  "oid": "1.3.6.1.4.1.61026.3.2.1",
  "name": "AI Normalizer Service",
  "scannedAt": 1706612400000,
  "deviceIP": "192.168.1.100",
  "wifiSSID": "BrainSAIT-Office"
}
```

## OID Namespace Reference

```
1.3.6.1.4.1.61026 (BrainSAIT Root)
├── .1 Geographic Operations
│   ├── .1 Riyadh
│   └── .2 Sudan
├── .2 Organization
│   ├── .1 Departments
│   │   ├── .1 Engineering
│   │   └── .2 Healthcare Operations
│   └── .2 Licensing
├── .3 Products & Services
│   ├── .1 Content Management
│   ├── .2 Healthcare Platform
│   │   ├── .1 AI Normalizer
│   │   ├── .2 Signer
│   │   └── .3 NPHIES Connector
│   └── .3 AI Agent Framework
└── .4 Infrastructure
    ├── .1 Ollama Cloud
    ├── .2 Docker
    └── .3 IoT Devices ← Scanner registered here
```

## Troubleshooting

### ESP32-CAM Won't Upload
- Ensure IO0 is connected to GND during upload
- Try different USB cable (data cable, not charge-only)
- Lower upload speed in Tools → Upload Speed → 115200

### QR Codes Not Detected
- Ensure adequate lighting (use flash: `digitalWrite(4, HIGH)`)
- Hold QR code 15-30cm from camera
- Clean camera lens
- Try larger QR code (minimum 3cm × 3cm)

### WiFi Connection Issues
- Verify SSID and password in config
- ESP32 only supports 2.4GHz WiFi (not 5GHz)
- Check router allows new devices

### GM65 Not Responding
- Verify TX/RX wiring (they cross over)
- Check baud rate matches (9600 default)
- Some modules need 5V logic level shifter

## 3D Printed Enclosure

STL files for a protective case are available in the `/enclosure` folder:
- `enclosure-esp32cam.stl` - For ESP32-CAM
- `enclosure-gm65.stl` - For GM65 module setup

## License

This project is part of BrainSAIT Enterprise infrastructure.
Licensed under CC BY-NC-SA 4.0.

## Support

- Issues: [GitHub Issues](https://github.com/Fadil369/brainsait-oid-integr/issues)
- Documentation: [BrainSAIT Wiki](https://wiki.brainsait.com)
- Engineering: engineering@brainsait.com
